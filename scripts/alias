#!/usr/bin/env bash
set -e

# ──────────────────────────────────────────────────────────────────────────────
# Configuration & paths
# ──────────────────────────────────────────────────────────────────────────────

CONFIG_FILE="$HOME/.local/share/nav2-modular/config"
CONTAINER_NAME="nav2_modular"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

DOCKER_DIR="$PROJECT_ROOT/Docker"
COMPOSE_FILE="$DOCKER_DIR/docker-compose.yaml"

# Create config on first run
if [[ ! -f "$CONFIG_FILE" ]]; then
    mkdir -p "$(dirname "$CONFIG_FILE")"
    echo "PROJECT_ROOT=\"$PROJECT_ROOT\"" > "$CONFIG_FILE"
    echo "DOCKER_DIR=\"$DOCKER_DIR\"" >> "$CONFIG_FILE"
    echo "Nav2 Modular config created at $CONFIG_FILE"
fi

source "$CONFIG_FILE" 2>/dev/null || true

if [[ ! -f "$COMPOSE_FILE" ]]; then
    echo "Error: docker-compose.yaml not found at $COMPOSE_FILE"
    echo "Check your folder structure or config file: $CONFIG_FILE"
    exit 1
fi

# ──────────────────────────────────────────────────────────────────────────────
# Usage
# ──────────────────────────────────────────────────────────────────────────────

usage() {
    cat <<EOF

Nav2 Modular CLI (ROS 2 Jazzy)

Usage: ./scripts/alias <command> [options]

Commands:
  start | s     Start container in detached mode
  stop  | x     Stop and remove container
  shell | sh    Open interactive bash shell inside container
  build | b [-v] Build or rebuild the image
  log   | l     Follow container logs
  help          Show this help

Examples:
  ./scripts/alias build
  ./scripts/alias build -v
  ./scripts/alias start
  ./scripts/alias shell
  ./scripts/alias log
  ./scripts/alias stop

Note:
  Robot/platform/hardware is selected at build time via --build-arg CONFIG=...
  Example: ./scripts/alias build --build-arg CONFIG=panther-ouster-depthai

EOF
}

# ──────────────────────────────────────────────────────────────────────────────
# Commands
# ──────────────────────────────────────────────────────────────────────────────

case "$1" in
    start|s)
        xhost +local:docker >/dev/null 2>&1 && echo "X11 access granted"
        docker compose -f "$COMPOSE_FILE" up -d
        ;;

    stop|x)
        docker compose -f "$COMPOSE_FILE" down
        echo "Container stopped and removed."
        ;;

    shell|sh)
        if ! docker ps -q -f name="$CONTAINER_NAME" >/dev/null; then
            echo "Container is not running. Run '$0 start' first."
            exit 1
        fi
        docker exec -it "$CONTAINER_NAME" bash -l
        ;;

    build|b)
        if docker ps -q -f name="$CONTAINER_NAME" >/dev/null; then
            echo "Container is running → stopping it first..."
            docker compose -f "$COMPOSE_FILE" down
        fi

        shift
        if [[ "$1" == "-v" || "$1" == "--verbose" ]]; then
            echo "Building with verbose output..."
            docker compose -f "$COMPOSE_FILE" build --progress=plain
        else
            echo "Building image..."
            docker compose -f "$COMPOSE_FILE" build
        fi
        ;;

    log|l)
        docker logs -f --tail 100 "$CONTAINER_NAME"
        ;;

    help|--help|"")
        usage
        exit 0
        ;;

    *)
        echo "Unknown command: $1"
        echo "Run '$0 help' for usage."
        exit 1
        ;;
esac
