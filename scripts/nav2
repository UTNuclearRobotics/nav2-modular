#!/usr/bin/env bash
set -e

# ──────────────────────────────────────────────────────────────────────────────
# Configuration & paths
# ──────────────────────────────────────────────────────────────────────────────

CONFIG_FILE="$HOME/.local/share/nav2-modular/config"
CONTAINER_NAME="nav2_modular"
DOCKER_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"  # parent of scripts/

# Create config on first run if missing (so you never see the error again)
if [[ ! -f "$CONFIG_FILE" ]]; then
    mkdir -p "$(dirname "$CONFIG_FILE")"
    echo "DOCKER_DIR=\"$DOCKER_DIR\"" > "$CONFIG_FILE"
    echo "NAV2 Modular config created at $CONFIG_FILE"
fi

# Source config file
. "$CONFIG_FILE"

if [[ ! -d "$DOCKER_DIR" ]]; then
    echo "Error: Docker directory '$DOCKER_DIR' not found."
    echo "Fix your config at $CONFIG_FILE or delete it and re-run."
    exit 1
fi

# ──────────────────────────────────────────────────────────────────────────────
# Usage
# ──────────────────────────────────────────────────────────────────────────────

usage() {
    cat <<EOF

Nav2 Modular CLI (ROS 2 Humble)

Usage: ./scripts/alias <command> [options]

Commands:
  start | s     Start container in detached mode
  stop  | x     Stop and remove container
  shell | sh    Open interactive bash shell inside container
  build | b [-v] Build or rebuild the image
  log   | l     Follow container logs
  help          Show this help

Examples:
  ./scripts/alias build
  ./scripts/alias build -v
  ./scripts/alias start
  ./scripts/alias shell
  ./scripts/alias log
  ./scripts/alias stop

Note:
  Robot/platform/hardware is selected at build time via --build-arg CONFIG=...
  Example: ./scripts/alias build --build-arg CONFIG=panther-ouster-depthai

EOF
}

# ──────────────────────────────────────────────────────────────────────────────
# Commands
# ──────────────────────────────────────────────────────────────────────────────

case "$1" in
    start|s)
        xhost +local:docker && echo "Xhost permissions added" && docker compose -f "$DOCKER_DIR/docker-compose.yaml" up -d ;;

    stop|x)
        docker compose -f "$DOCKER_DIR/docker-compose.yaml" down
        ;;

    shell|sh)
        docker exec -ti "$CONTAINER_NAME" bash -l
        ;;

    build|b)
        if [ "$(docker ps -q -f name=$CONTAINER_NAME)" ]; then
            echo "Stopping running container..."
            docker compose -f "$DOCKER_DIR/docker-compose.yaml" down
        fi
        shift
        if [ "$1" = "-v" ]; then
            echo "Building with verbose output..."
            docker compose -f "$DOCKER_DIR/docker-compose.yaml" build --progress=plain
        else
            echo "Building image..."
            docker compose -f "$DOCKER_DIR/docker-compose.yaml" build
        fi
        ;;

    log|l)
        docker logs -f "$CONTAINER_NAME"
        ;;

    help|--help|"")
        usage
        ;;

    *)
        echo "Unknown command: $1"
        echo "Run 'nav2 help' for usage."
        exit 1
        ;;
esac
